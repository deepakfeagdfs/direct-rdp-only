name: RDP-Miner-v3

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360        # 6 h GitHub hard ceiling (free)

    steps:
      # 1. Kill Windows session timeouts forever (registry)
      - name: Remove session limits
        shell: pwsh
        run: |
          $reg = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
          New-Item -Path $reg -Force | Out-Null
          Set-ItemProperty -Path $reg -Name MaxConnectionTime      -Value 0 -Type DWord -Force
          Set-ItemProperty -Path $reg -Name MaxIdleTime            -Value 0 -Type DWord -Force
          Set-ItemProperty -Path $reg -Name MaxDisconnectionTime   -Value 0 -Type DWord -Force
          gpupdate /force

      # 2. Core RDP enable + firewall
      - name: Configure RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      # 3. Create / re-create RDP user
      - name: Create RDP user
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.Security
          $charSet = @{Upper=[char[]](65..90);Lower=[char[]](97..122);Number=[char[]](48..57);Special=([char[]](33..47)+[char[]](58..64)+[char[]](91..96)+[char[]](123..126))}
          $rawPassword = @(); 1..4 | % { $rawPassword += $charSet.Upper | Get-Random }
          1..4 | % { $rawPassword += $charSet.Lower | Get-Random }; 1..4 | % { $rawPassword += $charSet.Number | Get-Random }
          1..4 | % { $rawPassword += $charSet.Special | Get-Random }
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $secPass = ConvertTo-SecureString $password -AsPlainText -Force
          if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) { Remove-LocalUser -Name "RDP" }
          New-LocalUser -Name "RDP" -Password $secPass -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      # 4. Install & connect Tailscale (hard-coded key)
      - name: Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msi   = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $msi -UseBasicParsing
          Start-Process msiexec.exe -Wait -NoNewWindow -ArgumentList "/i `"$msi`" /quiet /norestart"
          Remove-Item $msi -Force
      - name: Connect Tailscale
        shell: pwsh
        run: |
          $TsKey = "tskey-auth-kqdqFbg1tB21CNTRL-qSW5M1JkwAGYRqPxBboCBG6KkhkfwR7QJ"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$TsKey `
                               --hostname=gh-runner-$env:GITHUB_RUN_ID --accept-routes
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
